@using MudBlazor
@using MudBlazor.Utilities
@using PyroGeoBlazor.Leaflet.Models

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h6">Layer Style</MudText>
    </MudCardHeader>
    <MudCardContent>
        <MudStack Spacing="2">
            <MudStack>
                <MudText Typo="Typo.subtitle2">Stroke</MudText>
                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Square" Style="@($"color: {_color}")" Size="Size.Large" />
                    <MudColorPicker Value="_color" ValueChanged="OnColorChanged" ShowToolbar ShowAlpha="false" Label="Stroke Color" Placeholder="#3388ff" />
                </MudStack>
                <MudStack Row Spacing="2">
                    <MudNumericField T="double" @bind-Value="_weight" @bind-Value:after="ApplyChanges" Label="Weight" Min="0" Max="50" Immediate="true" />
                    <MudNumericField T="double" @bind-Value="_opacity" @bind-Value:after="ApplyChanges" Label="Opacity" Min="0" Max="1" Step="0.1" Immediate="true" />
                </MudStack>
                <MudStack Row Spacing="2">
                    <MudTextField @bind-Value="_lineCap" @bind-Value:after="ApplyChanges" Label="Line Cap" Placeholder="round" />
                    <MudTextField @bind-Value="_lineJoin" @bind-Value:after="ApplyChanges" Label="Line Join" Placeholder="round" />
                    <MudTextField @bind-Value="_dashArray" @bind-Value:after="ApplyChanges" Label="Dash Array" Placeholder="5,5" />
                </MudStack>
            </MudStack>

            <MudDivider />

            <MudStack>
                <MudText Typo="Typo.subtitle2">Fill</MudText>
                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Square" Style="@($"color: {_fillColor}")" Size="Size.Large" />
                    <MudColorPicker Value="_fillColor" ValueChanged="OnFillColorChanged" Label="Fill Color" ShowToolbar ShowAlpha="false" Placeholder="#3388ff" ColorPickerMode="ColorPickerMode.RGB" />
                    <MudNumericField T="double" @bind-Value="_fillOpacity" @bind-Value:after="ApplyChanges" Label="Fill Opacity" Min="0" Max="1" Step="0.1" Immediate="true" />
                </MudStack>
            </MudStack>
            
            <MudTextField @bind-Value="_className" @bind-Value:after="ApplyChanges" Label="Class Name" />
        </MudStack>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public PathOptions? Style { get; set; }

    [Parameter] public EventCallback<PathOptions> ApplyStyle { get; set; }

    public void SetStyle(PathOptions style)
    {
        Style = new PathOptions
        {
            Stroke = style.Stroke,
            Color = style.Color,
            Weight = style.Weight,
            Opacity = style.Opacity,
            Fill = style.Fill,
            FillColor = style.FillColor,
            FillOpacity = style.FillOpacity,
            LineCap = style.LineCap,
            LineJoin = style.LineJoin,
            DashArray = style.DashArray,
            ClassName = style.ClassName
        };
        OnParametersSet();
        StateHasChanged();
    }

    // Local editable fields to avoid mutating the incoming object until Apply
    private bool _stroke = true;
    private MudColor _color = "#3388ff";
    private double _weight = 3;
    private double _opacity = 1.0;
    private bool _fill = true;
    private MudColor _fillColor = "#3388ff";
    private double _fillOpacity = 0.2;
    private string? _lineCap = "round";
    private string? _lineJoin = "round";
    private string? _dashArray;
    private string? _className;

    // Track the last Style parameter we synced from to avoid overwriting user changes
    private PathOptions? _lastSyncedStyle;

    protected override void OnParametersSet()
    {
        // Only sync from Style parameter if it's actually a new/different instance
        // This prevents overwriting user's local changes when parent re-renders
        if (Style is not null && !ReferenceEquals(Style, _lastSyncedStyle))
        {
            _lastSyncedStyle = Style;
            _stroke = Style.Stroke;
            _color = MudColor.Parse(Style.Color) ?? _color;
            _weight = Style.Weight;
            _opacity = Style.Opacity;
            _fill = Style.Fill ?? _fill;
            _fillColor = MudColor.Parse(Style.FillColor) ?? _fillColor;
            _fillOpacity = Style.FillOpacity;
            _lineCap = Style.LineCap ?? _lineCap;
            _lineJoin = Style.LineJoin ?? _lineJoin;
            _dashArray = Style.DashArray;
            _className = Style.ClassName;
        }
    }
    
    private async Task ApplyChanges()
    {
        var result = new PathOptions
        {
            Stroke = _stroke,
            Color = _color.ToString(),
            Weight = _weight,
            Opacity = _opacity,
            Fill = _fill,
            FillColor = _fillColor.ToString(),
            FillOpacity = _fillOpacity,
            LineCap = _lineCap ?? "round",
            LineJoin = _lineJoin ?? "round",
            DashArray = _dashArray,
            ClassName = _className
        };

        if (ApplyStyle.HasDelegate)
        {
            await ApplyStyle.InvokeAsync(result);
        }
    }

    private async Task OnColorChanged(MudColor color)
    {
        _color = color;
        await ApplyChanges();
    }

    private async Task OnFillColorChanged(MudColor color)
    {
        _fillColor = color;
        await ApplyChanges();
    }
}


