@page "/wfs-layers"
@using PyroGeoBlazor.Demo.Models
@using PyroGeoBlazor.Leaflet.Components
@using PyroGeoBlazor.Leaflet.Models
@using PyroGeoBlazor.Models
@using PyroGeoBlazor.Components

<PageTitle>WFS Layers - PyroGeoBlazor Demo</PageTitle>

<div style="display: flex; flex-direction: row; height: 100%; overflow: hidden;">
    <div style="flex: 0 0 30%; overflow-y: auto; overflow-x: hidden;">
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
            <MudText Typo="Typo.h4" Class="mb-2">WFS Layers</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Dynamic feature loading with auto-refresh on pan/zoom and bounded by map view</MudText>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Layer Selector</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <WfsLayerSelector InitialUrl="https://lims.koleta.co.mz/geoserver/PlannerSpatial/ows?SERVICE=WFS&REQUEST=GetCapabilities"
                                      InitialVersion="2.0.0"
                                      OnConfigGenerated="HandleConfigGenerated" />
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Layer Options</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" Class="mb-2">Configure layer behavior before adding</MudText>
                    <MudDivider Class="my-2" />
                    
                    <MudNumericField @bind-Value="maxFeatures" 
                                     Label="Max Features" 
                                     Variant="Variant.Outlined" 
                                     Step="100"
                                     Min="100"
                                     Max="10000"
                                     HelperText="Maximum number of features to load"
                                     Class="mb-3" />

                    @if (loadedLayers.Count > 0)
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Update Settings</MudText>
                        <MudNumericField @bind-Value="newMaxFeatures" 
                                         Label="New Max Features" 
                                         Variant="Variant.Outlined" 
                                         Step="100"
                                         Min="100"
                                         Max="10000"
                                         HelperText="Change and apply new limit"
                                         Class="mb-2" />
                        
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Update"
                                   OnClick="UpdateMaxFeatures"
                                   Class="mb-2">
                            Apply New Limit
                        </MudButton>

                        <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   OnClick="ReloadWfsLayers"
                                   Class="mb-2">
                            Reload Layers
                        </MudButton>

                        <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                            <strong>Auto-Refresh:</strong> Enabled<br/>
                            <MudText Typo="Typo.caption">Features refresh automatically when you pan or zoom the map</MudText>
                        </MudAlert>

                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Selection</MudText>
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   OnClick="ClearSelection">
                            Clear Selection
                        </MudButton>

                        @if (selectedCount > 0)
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                                <strong>Selected:</strong> @selectedCount features
                            </MudAlert>
                        }
                        
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            <strong>Current Limit:</strong> @maxFeatures features
                        </MudAlert>
                    }
                </MudCardContent>
            </MudCard>

            @if (loadedLayers.Count > 0)
            {
                <MudCard Class="mb-3">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">Loaded Layers (@loadedLayers.Count)</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList Dense="true" T="string">
                            @foreach (var layer in loadedLayers)
                            {
                                <MudListItem>
                                    <MudText Typo="Typo.body2">@layer</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudCardContent>
                </MudCard>
            }

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">WFS Features</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudList Dense="true" T="string">
                        <MudListItem>Bounded by map view</MudListItem>
                        <MudListItem>Auto-refresh on pan/zoom</MudListItem>
                        <MudListItem>Incremental loading</MudListItem>
                        <MudListItem>Feature selection</MudListItem>
                        <MudListItem>GeoServer integration</MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Usage Tips</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudList Dense="true" T="string">
                        <MudListItem>Click "Load WFS Layer"</MudListItem>
                        <MudListItem>Pan or zoom the map</MudListItem>
                        <MudListItem>Watch features load automatically</MudListItem>
                        <MudListItem>Click features to select</MudListItem>
                        <MudListItem>Use Ctrl+Click for multiple</MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>

            <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/" Class="mt-3">
                Back to Home
            </MudButton>
        </MudContainer>
    </div>

    <div style="flex: 1 1 70%; min-width: 0; overflow: hidden;">
        <LeafletMap Height="100%" Map="PositionMap" TileLayer="OpenStreetMapsTileLayer" Controls="MapControls" />
    </div>
</div>
