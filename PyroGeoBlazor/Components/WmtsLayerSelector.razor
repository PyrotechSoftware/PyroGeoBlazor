@using PyroGeoBlazor.Models
@inject HttpClient HttpClient

<div class="wmts-layer-selector">
    <h3>WMTS Layer Selector</h3>
    
    <div class="form-group">
        <label for="wmtsUrl">GetCapabilities URL:</label>
        <input id="wmtsUrl" 
               type="text" 
               @bind="CapabilitiesUrl" 
               class="form-control" 
               placeholder="https://your-server.com/geoserver/gwc/service/wmts?REQUEST=GetCapabilities" />
    </div>

    <div class="form-group">
        <label for="wmtsVersion">WMTS Version:</label>
        <select id="wmtsVersion" @bind="SelectedVersion" class="form-control">
            <option value="1.0.0">1.0.0</option>
        </select>
    </div>

    <button @onclick="FetchCapabilities" disabled="@IsLoading" class="btn btn-primary">
        @if (IsLoading)
        {
            <span>Loading...</span>
        }
        else
        {
            <span>Get Capabilities</span>
        }
    </button>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mt-3">
            @ErrorMessage
        </div>
    }

    @if (Capabilities != null && Capabilities.Layers.Count > 0)
    {
        <div class="mt-3">
            <h4>Available Layers</h4>
            <div class="form-group">
                <label for="layerSelect">Select Layer:</label>
                <select id="layerSelect" @bind="SelectedLayerIdentifier" class="form-control">
                    <option value="">-- Select a layer --</option>
                    @foreach (var layer in Capabilities.Layers)
                    {
                        <option value="@layer.Identifier">@layer.Title (@layer.Identifier)</option>
                    }
                </select>
            </div>

            @if (!string.IsNullOrEmpty(SelectedLayerIdentifier))
            {
                var selectedLayer = Capabilities.Layers.FirstOrDefault(l => l.Identifier == SelectedLayerIdentifier);
                if (selectedLayer != null)
                {
                    <div class="layer-details mt-3">
                        <h5>Layer Details</h5>
                        <p><strong>Title:</strong> @selectedLayer.Title</p>
                        @if (!string.IsNullOrEmpty(selectedLayer.Abstract))
                        {
                            <p><strong>Description:</strong> @selectedLayer.Abstract</p>
                        }

                        @if (selectedLayer.TileMatrixSets.Count > 0)
                        {
                            <div class="form-group">
                                <label for="tileMatrixSet">Tile Matrix Set:</label>
                                <select id="tileMatrixSet" @bind="SelectedTileMatrixSet" class="form-control">
                                    @foreach (var tms in selectedLayer.TileMatrixSets)
                                    {
                                        <option value="@tms">@tms</option>
                                    }
                                </select>
                            </div>
                        }

                        @if (selectedLayer.Formats.Count > 0)
                        {
                            <div class="form-group">
                                <label for="format">Format:</label>
                                <select id="format" @bind="SelectedFormat" class="form-control">
                                    @foreach (var format in selectedLayer.Formats)
                                    {
                                        <option value="@format">@format</option>
                                    }
                                </select>
                            </div>
                        }

                        @if (selectedLayer.Styles.Count > 0)
                        {
                            <div class="form-group">
                                <label for="style">Style:</label>
                                <select id="style" @bind="SelectedStyle" class="form-control">
                                    @foreach (var style in selectedLayer.Styles)
                                    {
                                        <option value="@style.Identifier">@style.Title (@style.Identifier)</option>
                                    }
                                </select>
                            </div>
                        }

                        <button @onclick="GenerateUrlTemplate" class="btn btn-success mt-2">
                            Generate URL Template
                        </button>

                        @if (GeneratedUrlTemplate != null)
                        {
                            <div class="alert alert-success mt-3">
                                <h6>URL Template Generated</h6>
                                <p><strong>Template:</strong></p>
                                <code>@GeneratedUrlTemplate.UrlTemplate</code>
                                <p class="mt-2"><strong>Layer:</strong> @GeneratedUrlTemplate.Layer</p>
                                <p><strong>Tile Matrix Set:</strong> @GeneratedUrlTemplate.TileMatrixSet</p>
                                <p><strong>Format:</strong> @GeneratedUrlTemplate.Format</p>
                                <p><strong>Style:</strong> @GeneratedUrlTemplate.Style</p>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private string CapabilitiesUrl { get; set; } = string.Empty;
    private string SelectedVersion { get; set; } = "1.0.0";
    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }
    private WmtsCapabilities? Capabilities { get; set; }
    private string SelectedLayerIdentifier { get; set; } = string.Empty;
    private string SelectedTileMatrixSet { get; set; } = string.Empty;
    private string SelectedFormat { get; set; } = string.Empty;
    private string SelectedStyle { get; set; } = string.Empty;
    private WmtsUrlTemplate? GeneratedUrlTemplate { get; set; }

    /// <summary>
    /// Event that fires when a URL template is generated.
    /// </summary>
    [Parameter]
    public EventCallback<WmtsUrlTemplate> OnUrlTemplateGenerated { get; set; }

    /// <summary>
    /// Optional initial GetCapabilities URL to populate the input field.
    /// </summary>
    [Parameter]
    public string? InitialUrl { get; set; }

    /// <summary>
    /// Optional initial WMTS version to select (default: "1.0.0").
    /// </summary>
    [Parameter]
    public string? InitialVersion { get; set; }

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(InitialUrl))
        {
            CapabilitiesUrl = InitialUrl;
        }

        if (!string.IsNullOrEmpty(InitialVersion))
        {
            SelectedVersion = InitialVersion;
        }
    }

    private async Task FetchCapabilities()
    {
        IsLoading = true;
        ErrorMessage = null;
        Capabilities = null;
        GeneratedUrlTemplate = null;
        StateHasChanged();

        try
        {
            var url = CapabilitiesUrl;
            if (!url.Contains("REQUEST=GetCapabilities", StringComparison.OrdinalIgnoreCase))
            {
                var separator = url.Contains('?') ? '&' : '?';
                url = $"{url}{separator}SERVICE=WMTS&VERSION={SelectedVersion}&REQUEST=GetCapabilities";
            }

            var response = await HttpClient.GetStringAsync(url);
            Capabilities = ParseWmtsCapabilities(response, CapabilitiesUrl);

            if (Capabilities.Layers.Count == 0)
            {
                ErrorMessage = "No layers found in the GetCapabilities response.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error fetching capabilities: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private WmtsCapabilities ParseWmtsCapabilities(string xmlContent, string serviceUrl)
    {
        var capabilities = new WmtsCapabilities
        {
            ServiceUrl = serviceUrl
        };

        try
        {
            var doc = System.Xml.Linq.XDocument.Parse(xmlContent);
            var ns = doc.Root?.Name.Namespace ?? System.Xml.Linq.XNamespace.None;
            var owsNs = System.Xml.Linq.XNamespace.Get("http://www.opengis.net/ows/1.1");

            // Parse service identification
            var serviceId = doc.Root?.Element(owsNs + "ServiceIdentification");
            if (serviceId != null)
            {
                capabilities.ServiceTitle = serviceId.Element(owsNs + "Title")?.Value ?? string.Empty;
                capabilities.ServiceAbstract = serviceId.Element(owsNs + "Abstract")?.Value ?? string.Empty;
            }

            // Parse layers
            var contents = doc.Root?.Element(ns + "Contents");
            if (contents != null)
            {
                foreach (var layerElement in contents.Elements(ns + "Layer"))
                {
                    var layer = new WmtsLayerInfo
                    {
                        Identifier = layerElement.Element(owsNs + "Identifier")?.Value ?? string.Empty,
                        Title = layerElement.Element(owsNs + "Title")?.Value ?? string.Empty,
                        Abstract = layerElement.Element(owsNs + "Abstract")?.Value ?? string.Empty
                    };

                    // Parse formats
                    layer.Formats = layerElement.Elements(ns + "Format")
                        .Select(f => f.Value)
                        .ToList();

                    // Parse tile matrix set links
                    layer.TileMatrixSets = layerElement.Elements(ns + "TileMatrixSetLink")
                        .Select(tms => tms.Element(ns + "TileMatrixSet")?.Value ?? string.Empty)
                        .Where(tms => !string.IsNullOrEmpty(tms))
                        .ToList();

                    // Parse styles
                    foreach (var styleElement in layerElement.Elements(ns + "Style"))
                    {
                        var style = new WmtsStyleInfo
                        {
                            Identifier = styleElement.Element(owsNs + "Identifier")?.Value ?? string.Empty,
                            Title = styleElement.Element(owsNs + "Title")?.Value ?? string.Empty,
                            IsDefault = styleElement.Attribute("isDefault")?.Value == "true"
                        };
                        layer.Styles.Add(style);
                    }

                    // Parse bounding box
                    var wgs84BBox = layerElement.Element(owsNs + "WGS84BoundingBox");
                    if (wgs84BBox != null)
                    {
                        var lowerCorner = wgs84BBox.Element(owsNs + "LowerCorner")?.Value.Split(' ');
                        var upperCorner = wgs84BBox.Element(owsNs + "UpperCorner")?.Value.Split(' ');
                        
                        if (lowerCorner?.Length == 2 && upperCorner?.Length == 2)
                        {
                            layer.BoundingBox = new WmtsBoundingBox
                            {
                                MinX = double.Parse(lowerCorner[0], System.Globalization.CultureInfo.InvariantCulture),
                                MinY = double.Parse(lowerCorner[1], System.Globalization.CultureInfo.InvariantCulture),
                                MaxX = double.Parse(upperCorner[0], System.Globalization.CultureInfo.InvariantCulture),
                                MaxY = double.Parse(upperCorner[1], System.Globalization.CultureInfo.InvariantCulture)
                            };
                        }
                    }

                    capabilities.Layers.Add(layer);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing WMTS capabilities: {ex.Message}");
        }

        return capabilities;
    }

    private void GenerateUrlTemplate()
    {
        if (string.IsNullOrEmpty(SelectedLayerIdentifier) || Capabilities == null)
        {
            return;
        }

        var layer = Capabilities.Layers.FirstOrDefault(l => l.Identifier == SelectedLayerIdentifier);
        if (layer == null)
        {
            return;
        }

        // Use selected values or defaults
        var tileMatrixSet = !string.IsNullOrEmpty(SelectedTileMatrixSet) ? SelectedTileMatrixSet : layer.TileMatrixSets.FirstOrDefault() ?? string.Empty;
        var format = !string.IsNullOrEmpty(SelectedFormat) ? SelectedFormat : layer.Formats.FirstOrDefault() ?? "image/png";
        var style = !string.IsNullOrEmpty(SelectedStyle) ? SelectedStyle : layer.Styles.FirstOrDefault()?.Identifier ?? string.Empty;

        // Extract base URL without query parameters
        var baseUrl = Capabilities.ServiceUrl.Split('?')[0];
        
        // Determine file extension from format
        var extension = format.Contains("png") ? "png" : format.Contains("jpeg") || format.Contains("jpg") ? "jpg" : "png";

        // Build URL template (RESTful format commonly used by GeoServer)
        var urlTemplate = $"{baseUrl}/1.0.0/{SelectedLayerIdentifier}/{style}/{tileMatrixSet}/{{z}}/{{y}}/{{x}}.{extension}";

        GeneratedUrlTemplate = new WmtsUrlTemplate
        {
            UrlTemplate = urlTemplate,
            Layer = SelectedLayerIdentifier,
            TileMatrixSet = tileMatrixSet,
            Format = format,
            Style = style
        };

        // Invoke callback
        OnUrlTemplateGenerated.InvokeAsync(GeneratedUrlTemplate);
        StateHasChanged();
    }
}
