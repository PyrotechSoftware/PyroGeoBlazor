@page "/deckgl-demo"
@using PyroGeoBlazor.DeckGL.Components
@using PyroGeoBlazor.DeckGL.Models

<PageTitle>Deck.GL Demo - PyroGeoBlazor</PageTitle>

<div style="display: flex; flex-direction: row; height: 100%; overflow: hidden;">
    <div style="flex: 0 0 30%; overflow-y: auto; overflow-x: hidden;">
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
            <MudText Typo="Typo.h4" Class="mb-2">Deck.GL Bridge</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">High-performance WebGL-powered visualization with Deck.GL</MudText>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Layer Controls</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudSwitch T="bool" Color="Color.Primary" Label="@($"OSM Base Layer ({(showOsmBaseLayer ? "On" : "Off")})")"
                                   Value="@showOsmBaseLayer" ValueChanged="value => { showOsmBaseLayer = value; UpdateLayers(); }" />
                        <MudSwitch T="bool" Color="Color.Primary" Label="@($"GeoJSON Layer ({(showGeoJsonLayer ? "On" : "Off")})")"
                                   Value="@showGeoJsonLayer" ValueChanged="value => { showGeoJsonLayer = value; UpdateLayers(); }" />
                        <MudSwitch T="bool" Color="Color.Primary" Label="@($"Scatterplot Layer ({(showScatterplotLayer ? "On" : "Off")})")"
                                   Value="@showScatterplotLayer" ValueChanged="value => { showScatterplotLayer = value; UpdateLayers(); }" />
                        <MudSwitch T="bool" Color="Color.Primary" Label="@($"MVT Layers ({(showMvtLayer ? "On" : "Off")})")"
                                   Value="@showMvtLayer" ValueChanged="value => { showMvtLayer = value; UpdateLayers(); }" />
                    </MudStack>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" FullWidth="true"
                               StartIcon="@Icons.Material.Filled.ClearAll"
                               OnClick="ClearCache"
                               Class="mt-2">
                        Clear Cache
                    </MudButton>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Layer Visibility</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" FullWidth="true"
                                   OnClick="@(() => ToggleLayerVisibilityAsync("geojson-layer"))">
                            Toggle GeoJSON Layer
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" FullWidth="true"
                                   OnClick="@(() => ToggleLayerVisibilityAsync("scatterplot-layer"))">
                            Toggle Scatterplot Layer
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">View State</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2">
                        <strong>Longitude:</strong> @viewState.Longitude.ToString("F4")<br/>
                        <strong>Latitude:</strong> @viewState.Latitude.ToString("F4")<br/>
                        <strong>Zoom:</strong> @viewState.Zoom.ToString("F2")
                    </MudText>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Selection</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudButton Variant="Variant.Filled" 
                               Color="@(isDrawingMode ? Color.Error : Color.Primary)" 
                               Size="Size.Small" 
                               FullWidth="true"
                               StartIcon="@(isDrawingMode ? Icons.Material.Filled.Cancel : Icons.Material.Filled.Draw)"
                               OnClick="ToggleDrawingMode">
                        @(isDrawingMode ? "Cancel Selection Mode" : "Start Polygon Selection")
                    </MudButton>

                    @if (isDrawingMode)
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                            <strong>Drawing Mode Active:</strong> Click to add polygon vertices. Double-click to complete and select features.
                        </MudAlert>
                    }

                    @if (lastSelectionResult != null)
                    {
                        <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                            <strong>Selection Complete:</strong> @lastSelectionResult.FeatureCount features selected
                        </MudAlert>
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   OnClick="ClearSelectionAsync"
                                   Class="mt-1">
                            Clear Selection
                        </MudButton>
                    }
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Global Selection Style</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" FullWidth="true"
                                   Style="background-color: #FFFF00; color: black;"
                                   OnClick="() => SetGlobalSelectionStyleAsync(FeatureStyle.Yellow)">
                            Yellow (Default)
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" FullWidth="true"
                                   OnClick="() => SetGlobalSelectionStyleAsync(FeatureStyle.Red)">
                            Red
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small" FullWidth="true"
                                   OnClick="() => SetGlobalSelectionStyleAsync(FeatureStyle.Green)">
                            Green
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" Size="Size.Small" FullWidth="true"
                                   OnClick="() => SetGlobalSelectionStyleAsync(FeatureStyle.Blue)">
                            Blue
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Layer Feature Styles</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" FullWidth="true"
                                   Style="background-color: #FFA500; color: white;"
                                   OnClick="() => SetLayerFeatureStyleAsync(FeatureStyle.Orange)">
                            Orange
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" FullWidth="true"
                                   Style="background-color: #800080; color: white;"
                                   OnClick="() => SetLayerFeatureStyleAsync(FeatureStyle.Purple)">
                            Purple
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" FullWidth="true"
                                   Style="background-color: #00FFFF; color: black;"
                                   OnClick="SetCustomStyle">
                            Custom (Cyan 30%)
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" FullWidth="true"
                                   OnClick="ResetLayerStyle">
                            Reset to Default
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Tooltip Configuration</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" FullWidth="true"
                                   OnClick="SetTooltipForProperties">
                            Show Specific Properties
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" FullWidth="true"
                                   OnClick="SetTooltipFormatted">
                            Use Formatted Tooltip
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" FullWidth="true"
                                   OnClick="DisableTooltips">
                            Disable Tooltips
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" FullWidth="true"
                                   OnClick="ResetTooltips">
                            Reset to Default
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudCard Class="mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Features</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudList Dense="true" T="string">
                        <MudListItem>GeoJSON & Scatterplot layers</MudListItem>
                        <MudListItem>OpenStreetMap base layer</MudListItem>
                        <MudListItem>MVT layer support</MudListItem>
                        <MudListItem>Interactive tooltips</MudListItem>
                        <MudListItem>Polygon selection</MudListItem>
                        <MudListItem>Dynamic styling</MudListItem>
                        <MudListItem>Layer visibility control</MudListItem>
                    </MudList>
                </MudCardContent>
            </MudCard>

            <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/" Class="mt-3">
                Back to Home
            </MudButton>
        </MudContainer>
    </div>

    <div style="flex: 1 1 70%; min-width: 0; overflow: hidden; position: relative;">
        <div style="width: 100%; height: 100%;">
            <DeckGLView @ref="deckGLView"
                        ContainerId="demo-deckgl"
                        InitialViewState="@initialViewState"
                        Controller="true"
                        EnableTooltips="true"
                        Layers="@layers"
                        OnViewStateChanged="@OnViewStateChanged"
                        OnLayerClick="@OnLayerClick"
                        OnLayerHover="@OnLayerHover"
                        OnFeaturesSelectedCallback="@OnFeaturesSelected" />
        </div>
    </div>
</div>

@code {
    private DeckGLView? deckGLView;
    private ViewState initialViewState = new()
{
    Longitude = -123.13,  // Vancouver coordinates
    Latitude = 49.28,
    Zoom = 11,
    Pitch = 0,
    Bearing = 0
};
    private ViewState viewState = new()
{
    Longitude = -123.13,
    Latitude = 49.28,
    Zoom = 11
};

    private List<LayerConfig> layers = [];
    private bool showGeoJsonLayer = true;
    private bool showScatterplotLayer = false;
    private bool showOsmBaseLayer = true;  // OSM base layer enabled by default
    private bool showMvtLayer = false;  // MVT layer disabled by default (requires GeoServer)
    private bool isDrawingMode = false;
    private FeatureSelectionResult? lastSelectionResult = null;

    protected override void OnInitialized()
    {
        UpdateLayers();
    }

    private void UpdateLayers()
    {
        layers.Clear();

        // Add OpenStreetMap base layer first (renders underneath)
        if (showOsmBaseLayer)
        {
            var osmLayer = TileLayerConfig.OpenStreetMap("osm-base");
            layers.Add(osmLayer);
        }

        if (showGeoJsonLayer)
        {
            // Example: GeoJSON layer fetching data from an API
            var geoJsonLayer = new GeoJsonLayerConfig
            {
                Id = "geojson-layer",
                DataUrl = "https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/geojson/vancouver-blocks.json",
                Pickable = true,
                Stroked = true,
                Filled = true,
                Extruded = false,
                LineWidthScale = 20,
                LineWidthMinPixels = 2,
                FillColor = [160, 160, 180, 100],
                LineColor = [80, 80, 80, 255],

                // Set layer-specific selection style (red for this layer)
                SelectionStyle = FeatureStyle.Red,

                // Set hover style (light blue for this layer)
                HoverStyle = new FeatureStyle
                {
                    FillColor = "#4FC3F7",  // Light blue
                    FillOpacity = 0.7,
                    LineColor = "#0288D1",   // Darker blue
                    Opacity = 1.0,
                    LineWidth = 2
                },

                // Set tooltip to show specific attributes
                TooltipConfig = TooltipConfig.ForProperties("valuePerSqm")
            };
            layers.Add(geoJsonLayer);
        }

        if (showScatterplotLayer)
        {
            // Example: Scatterplot layer with inline data
            var scatterplotLayer = new ScatterplotLayerConfig
            {
                Id = "scatterplot-layer",
                Pickable = true,
                Opacity = 0.8,
                Stroked = true,
                Filled = true,
                RadiusScale = 30,
                RadiusMinPixels = 5,
                RadiusMaxPixels = 500,
                LineWidthMinPixels = 2,
                FillColor = [255, 140, 0, 200],
                LineColor = [0, 0, 0, 255],

                // Set layer-specific selection style (green for this layer)
                SelectionStyle = FeatureStyle.Green
            };

            // Sample data
            scatterplotLayer.Data = new[]
            {
                new { position = new[] { -123.13, 49.28 }, radius = 100 },
                new { position = new[] { -123.14, 49.29 }, radius = 80 },
                new { position = new[] { -123.12, 49.27 }, radius = 120 }
            };

            layers.Add(scatterplotLayer);
        }

        // Add MVT layer example (commented out - requires GeoServer)
        if (showMvtLayer)
        {
            // Example: MVT layer from GeoServer
            // Replace with your GeoServer URL, workspace, and layer name
            var townshipLayer = MVTLayerConfig.FromGeoServer(
                id: "township-layer",
                geoserverUrl: "https://lims.koleta.co.mz/geoserver",
                workspace: "PlannerSpatial",
                    layerName: "Township"
            );

            // IMPORTANT: Specify the property to use as unique ID for feature deduplication
            // MVT features that span multiple tiles will appear multiple times,
            // but this ensures they are treated as a single feature
            townshipLayer.UniqueIdProperty = "GeoTownshipID";

            // Optional: Customize styling
            townshipLayer.FillColor = [100, 150, 200, 150];
            townshipLayer.LineColor = [50, 50, 50, 255];
            townshipLayer.SelectionStyle = FeatureStyle.Blue;
            townshipLayer.HoverStyle = new FeatureStyle
            {
                FillColor = "#FFD700",  // Gold
                FillOpacity = 0.8,
                LineColor = "#FF8C00",
                Opacity = 1.0
            };
            townshipLayer.TooltipConfig = TooltipConfig.ForProperties("CustomIdentifier", "GeoPropertyID");
            layers.Add(townshipLayer);

            // Example: MVT layer from GeoServer
            // Replace with your GeoServer URL, workspace, and layer name
            var parcelsLayer = MVTLayerConfig.FromGeoServer(
                    id: "parcels-layer",
                    geoserverUrl: "https://lims.koleta.co.mz/geoserver",
                    workspace: "PlannerSpatial",
                    layerName: "vwParcelsLayer"
                );

            // IMPORTANT: Specify the property to use as unique ID for feature deduplication
            // MVT features that span multiple tiles will appear multiple times,
            // but this ensures they are treated as a single feature
            parcelsLayer.UniqueIdProperty = "GeoPropertyID";

            // Optional: Customize styling
            parcelsLayer.FillColor = [100, 150, 200, 150];
            parcelsLayer.LineColor = [50, 50, 50, 255];
            parcelsLayer.SelectionStyle = FeatureStyle.Blue;
            parcelsLayer.HoverStyle = new FeatureStyle
            {
                FillColor = "#FFD700",  // Gold
                FillOpacity = 0.8,
                LineColor = "#FF8C00",
                Opacity = 1.0
            };
            parcelsLayer.TooltipConfig = TooltipConfig.ForProperties("CustomIdentifier", "GeoPropertyID");

            layers.Add(parcelsLayer);
        }

        // Notify the component to update
        if (deckGLView != null)
        {
            InvokeAsync(async () => await deckGLView.UpdateLayers());
        }
    }

    private void OnViewStateChanged(ViewState newViewState)
    {
        viewState = newViewState;
        StateHasChanged();
    }

    private void OnLayerClick(LayerClickEventArgs args)
    {
        Console.WriteLine($"Layer clicked: {args.LayerId}");
        Console.WriteLine($"Object: {System.Text.Json.JsonSerializer.Serialize(args.Object)}");
    }

    private void OnLayerHover(LayerHoverEventArgs args)
    {
        // Console.WriteLine($"Layer hovered: {args.LayerId}");
    }

    private async Task ClearCache()
    {
        if (deckGLView != null)
        {
            await deckGLView.ClearCache();
            Console.WriteLine("Cache cleared");
        }
    }

    private async Task ToggleDrawingMode()
    {
        if (isDrawingMode)
        {
            // Cancel drawing mode and clear selection
            isDrawingMode = false;

            if (deckGLView != null)
            {
                await deckGLView.SetDrawingMode(false);
                // Optionally clear selection when exiting drawing mode
                // await deckGLView.ClearSelection();
                // lastSelectionResult = null;
            }
        }
        else
        {
            // Start drawing mode
            isDrawingMode = true;

            if (deckGLView != null)
            {
                await deckGLView.SetDrawingMode(true);
            }
        }

        StateHasChanged();
    }

    private void OnFeaturesSelected(FeatureSelectionResult result)
    {
        lastSelectionResult = result;
        // Keep drawing mode active - don't automatically exit
        // isDrawingMode = false;

        Console.WriteLine($"✅ Selected {result.FeatureCount} features!");
        foreach (var feature in result.Features)
        {
            Console.WriteLine($"  Layer: {feature.LayerId}");
            Console.WriteLine($"  Feature: {System.Text.Json.JsonSerializer.Serialize(feature.Feature)}");
        }

        StateHasChanged();
    }

    private async Task ClearSelectionAsync()
    {
        if (deckGLView != null)
        {
            await deckGLView.ClearSelection();
            lastSelectionResult = null;
            StateHasChanged();
        }
    }

    private async Task SetGlobalSelectionStyleAsync(FeatureStyle style)
    {
        if (deckGLView != null)
        {
            await deckGLView.SetGlobalSelectionStyle(style);
        }
    }

    private async Task SetLayerFeatureStyleAsync(FeatureStyle style)
    {
        if (deckGLView != null)
        {
            await deckGLView.SetLayerFeatureStyle("geojson-layer", style);
        }
    }

    private async Task ResetLayerStyle()
    {
        if (deckGLView != null)
        {
            // Reset by setting original colors (using hex)
            await deckGLView.SetLayerFeatureStyle("geojson-layer", new FeatureStyle
            {
                FillColor = "#A0A0B4",  // rgb(160, 160, 180)
                FillOpacity = 0.4,       // ~100/255
                LineColor = "#505050",   // rgb(80, 80, 80)
                Opacity = 1.0
            });
        }
    }

    private async Task SetCustomStyle()
    {
        if (deckGLView != null)
        {
            // Example: Custom cyan color with low opacity
            await deckGLView.SetLayerFeatureStyle("geojson-layer", new FeatureStyle
            {
                FillColor = "#00FFFF",  // Cyan
                FillOpacity = 0.3,       // 30% opacity
                LineColor = "#00AAAA",   // Darker cyan
                Opacity = 0.8,           // 80% opacity for borders
                LineWidth = 2
            });
        }
    }

    private async Task ToggleLayerVisibilityAsync(string layerId)
    {
        if (deckGLView != null)
        {
            var newVisibility = await deckGLView.ToggleLayerVisibility(layerId);
            Console.WriteLine($"Layer {layerId} visibility toggled to: {newVisibility}");
            StateHasChanged();
        }
    }

    private async Task SetTooltipForProperties()
    {
        if (deckGLView != null)
        {
            // Show only specific properties from GeoJSON features
            var config = TooltipConfig.ForProperties("AREA_S_CD", "FEATURE_AREA_SQM");
            var parcelConfig = TooltipConfig.ForProperties("CustomIdentifier");
            var townshipConfig = TooltipConfig.ForProperties("TownshipName");
            await deckGLView.SetLayerTooltipConfig("geojson-layer", config);
            await deckGLView.SetLayerTooltipConfig("parcels-layer", parcelConfig);
            await deckGLView.SetLayerTooltipConfig("township-layer", townshipConfig);
        }
    }

    private async Task SetTooltipFormatted()
    {
        if (deckGLView != null)
        {
            // Use a formatted string
            var config = TooltipConfig.WithFormat(
                "Area Code: {AREA_S_CD}\\nArea: {FEATURE_AREA_SQM} m²"
            );
            await deckGLView.SetLayerTooltipConfig("geojson-layer", config);
        }
    }

    private async Task DisableTooltips()
    {
        if (deckGLView != null)
        {
            await deckGLView.SetLayerTooltipConfig("geojson-layer", TooltipConfig.Disabled);
            await deckGLView.SetLayerTooltipConfig("parcels-layer", TooltipConfig.Disabled);
            await deckGLView.SetLayerTooltipConfig("township-layer", TooltipConfig.Disabled);
        }
    }

    private async Task ResetTooltips()
    {
        if (deckGLView != null)
        {
            await deckGLView.SetLayerTooltipConfig("geojson-layer", null);
            await deckGLView.SetLayerTooltipConfig("parcels-layer", null);
            await deckGLView.SetLayerTooltipConfig("township-layer", null);
        }
    }
}
