@namespace PyroGeoBlazor.DeckGL.Components
@using MudBlazor.Extensions.Options
@using MudBlazor.Utilities
@using PyroGeoBlazor.DeckGL.Models
@using PyroGeoBlazor.Utilities

@inject IDialogService DialogService

@if (Layers != null && Layers.Any())
{
    <MudDropContainer T="LayerConfig" Items="LayersReverse" ItemsSelector="@((item, dropzone) => true )" Class="d-flex flex-column" ItemDropped="@(OnDropHandler)" Style="height:100%; box-sizing:border-box;">
        <ChildContent>
            <MudTreeView T="LayerConfig" Dense Class="d-flex-column mud-height-full">
                <MudDropZone T="LayerConfig" Identifier="contents" Class="flex-grow-1" AllowReorder />
            </MudTreeView>
        </ChildContent>
        <ItemRenderer>
            <MudTreeViewItem T="LayerConfig" Expanded ExpandButtonIcon="@(context.Type == "TileLayer" ? "" : Icons.Material.Outlined.KeyboardArrowRight)">
                <BodyContent Context="item">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudCheckBox T="bool" 
                                 Value="@context.Visible"
                                 ValueChanged="@(async (bool newValue) => await OnVisibilityToggled(context.Id, newValue))"
                                 Color="Color.Primary"
                                 Disabled="@IsLocked" />
                    <MudText Typo="Typo.body2" Style="flex: 1;">
                        @context.Id
                    </MudText>
                    </MudStack>
                </BodyContent>
                <ChildContent>
                    @if (context.Type != "TileLayer")
                    {
                        <MudTreeViewItem T="string">
                            <BodyContent Context="layerContext">
                                <MudTooltip Text="@(IsLocked ? "Layer control is locked" : "Adjust Symbology")" Delay="500">
                                    <MudIconButton Icon="@Icons.Material.Filled.Square" 
                                                   Style="@($"color: {GetLayerColor(context)}")" 
                                                   Size="Size.Large"
                                                   Disabled="@IsLocked"
                                                   OnClick="@(() => OpenColorPicker(context))" />
                                </MudTooltip>
                            </BodyContent>
                        </MudTreeViewItem>
                    }
                </ChildContent>
            </MudTreeViewItem>
        </ItemRenderer>
    </MudDropContainer>
}
else
{
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-2">
        No layers
    </MudText>
}

@code {
private List<LayerConfig> Layers => DeckGLView?.Layers.ToList() ?? [];
private List<LayerConfig> LayersReverse => Layers.AsEnumerable().Reverse().ToList();

/// <summary>
/// Reference to the DeckGLView component. The LayerContentsControl will read layers
/// and interact directly with the DeckGLView.
/// </summary>
[Parameter, EditorRequired] 
public DeckGLView? DeckGLView { get; set; }

    /// <summary>
    /// Controls whether the layer control UI is locked (read-only).
    /// When true, users cannot:
    /// - Reorder layers (drag and drop disabled)
    /// - Toggle layer visibility (checkboxes disabled)
    /// - Change layer symbology/colors (color picker disabled)
    /// 
    /// This is independent of LayerConfig.IsEditable which controls whether
    /// individual layer's feature data can be edited.
    /// </summary>
    [Parameter] public bool IsLocked { get; set; }

    private async Task OnVisibilityToggled(string layerId, bool newValue)
    {
        if (DeckGLView is not null)
        {
            await DeckGLView.SetLayerVisibility(layerId, newValue);
            StateHasChanged();
        }
    }

    private async Task OnDropHandler(MudItemDropInfo<LayerConfig> dropInfo)
    {
        if (IsLocked || dropInfo?.Item is null || DeckGLView is null) return;

        var source = Layers.IndexOf(dropInfo.Item);

        // Convert the drop index from reversed display order to original order
        var count = Layers.Count;
        var target = count - 1 - dropInfo.IndexInZone; // Mathematical inverse to get the correct index to move to.

        if (source >= 0 && target >= 0 && source != target)
        {
            await DeckGLView.MoveLayerToIndex(dropInfo.Item.Id, target);
            StateHasChanged();
        }
    }

    private string GetLayerColor(LayerConfig layer)
    {
        if (layer.FeatureStyle?.FillColor != null)
        {
            return layer.FeatureStyle.FillColor;
        }

        if (layer is GeoJsonLayerConfig geoJsonLayer)
        {
            if (geoJsonLayer.FillColor is not null)
            {
                return ColorUtilities.RGBToHex(geoJsonLayer.FillColor);
            }
        }

        return "#000000";
    }

    private bool IsLayerLocked(LayerConfig layer)
    {
        // IsLocked controls whether the CONTROL UI is locked (symbology changes, reordering, etc.)
        // This is independent of layer.IsEditable which controls feature data editing
        return IsLocked;
    }

    private async Task OpenColorPicker(LayerConfig layer)
    {
        // Don't open if locked
        if (IsLayerLocked(layer))
            return;
    
        var currentColor = GetLayerColor(layer);
        var mudColor = new MudColor(currentColor);

        var parameters = new DialogParameters<LayerColorPickerDialog>
        {
            { x => x.SelectedColor, mudColor },
            { x => x.DisableAlpha, false }
        };

        var options = new DialogOptionsEx
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = false,
            DragMode = MudDialogDragMode.Simple,
            Position = DialogPosition.Center,
            Resizeable = true
        };

        var dialog = await DialogService.ShowExAsync<LayerColorPickerDialog>(
            $"Change Color - {layer.Id}",
            parameters,
            options);

        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is MudColor newColor && DeckGLView is not null)
        {
            // Update the layer's feature style
            var hexColor = newColor.ToString(MudColorOutputFormats.Hex);
            var opacity = newColor.A / 255.0;

            var featureStyle = layer.FeatureStyle ?? new FeatureStyle();
            featureStyle.LineColor = hexColor;
            featureStyle.FillColor = hexColor;
            featureStyle.FillOpacity = opacity;
            featureStyle.Opacity = 1;

            // For GeoJsonLayerConfig, also update the direct FillColor and LineColor properties
            if (layer is GeoJsonLayerConfig geoJsonLayer)
            {
                var color = System.Drawing.ColorTranslator.FromHtml(hexColor);
                geoJsonLayer.FillColor = [color.R, color.G, color.B, (int)(opacity * 255)];
                geoJsonLayer.LineColor = [color.R, color.G, color.B, 255];
            }

            // Apply the new style to the layer
            await DeckGLView.SetLayerFeatureStyle(layer.Id, featureStyle);
            StateHasChanged();
        }
    }
}
