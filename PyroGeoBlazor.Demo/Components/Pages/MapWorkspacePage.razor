@page "/map-workspace"
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using MudBlazor.Utilities
@using PyroGeoBlazor.DeckGL.Components
@using PyroGeoBlazor.DeckGL.Models
@using PyroGeoBlazor.Demo.Models
@using System.Globalization

<div style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
    <MapToolbar CurrentMode="@currentMapMode" CurrentModeChanged="@OnMapModeChanged">
        <MudText Typo="Typo.body2" Class="ml-3">
            Current Mode: <strong>@currentMapMode</strong>
        </MudText>
    </MapToolbar>

    <div style="flex: 1 1 auto; overflow: hidden; min-height: 0;">
        <MudExDockLayout ContainerStyle="height: 100%; overflow: hidden;">
            <MudExDockItem HideHeader Direction="DockDirection.Left" MaximumWidth="300">
                <MudCard Elevation="4" Style="height: 100%; display: flex; flex-direction: column;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText>Layers</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                        <LayerContentsControl DeckGLView="@deckGLView"
                                              IsLocked="false" />
                    </MudCardContent>
                </MudCard>
            </MudExDockItem>
            <MudExDockItem HideHeader Style="display: flex; flex-direction: column;">
                <DeckGLView @ref="deckGLView"
                            ContainerId="workspace-deckgl"
                            InitialViewState="@initialViewState"
                            Controller="true"
                            EnableTooltips="true"
                            OnViewStateChanged="@OnViewStateChanged"
                            OnDeckInitialized="@OnDeckInitialized">
                    <LayersContent>
                        <TileLayer Id="carto-basemap"
                                   TileUrl="https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"
                                   Pickable="false"
                                   Visible="true" />

                        @* <GeoJsonLayer Id="vancouver-blocks"
                                      DataUrl="https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/geojson/vancouver-blocks.json"
                                      Pickable="true"
                                      Stroked="true"
                                      Filled="true"
                                      Extruded="false"
                                      LineWidthScale="1"
                                      LineWidthMinPixels="2"
                                      FillColor="@(new[] { 160, 160, 180, 100 })"
                                      LineColor="@(new[] { 80, 80, 80, 255 })"
                                      UniqueIdProperty="id"
                                      DisplayProperty="id"
                                      IsEditable="true"
                                      TooltipConfig="@TooltipConfig.ForProperties("valuePerSqm")"
                                      EditableFields="@([
                                                                                            new AttributeFieldConfig
                                                                                            {
                                                                                                FieldName = "id",
                                                                                                DisplayName = "ID",
                                                                                                DataType = AttributeDataType.String,
                                                                                                IsReadOnly = true,
                                                                                                Order = 1
                                                                                            },
                                                                                            new AttributeFieldConfig
                                                                                            {
                                                                                                FieldName = "valuePerSqm",
                                                                                                DisplayName = "Value per Sqm",
                                                                                                DataType = AttributeDataType.Integer,
                                                                                                IsReadOnly = false,  // Allow editing
                                                                                                Placeholder = "Enter value",
                                                                                                HelpText = "Property value per square meter",
                                                                                                Order = 2
                                                                                            },
                                                                                            new AttributeFieldConfig
                                                                                            {
                                                                                                FieldName = "growth",
                                                                                                DisplayName = "Growth",
                                                                                                DataType = AttributeDataType.Double,
                                                                                                IsReadOnly = true,
                                                                                                Order = 3
                                                                                            }
                                                                                        ])"
                                      ExcludedProperties="@(["growth"])" /> *@

                        <GeoJsonLayer Id="Townships"
                                      DataUrl="api/townships"
                                      Pickable="false"
                                      Extruded="false"
                                      LineWidthScale="1"
                                      LineWidthMinPixels="1"
                                      TooltipConfig="@TooltipConfig.ForProperties("townName")"
                                      UniqueIdProperty="geoTownshipId"
                                      DisplayProperty="townName"
                                      LabelProperty="townName"
                                      LabelsEnabled="true"
                                      LabelMinZoom="0"
                                      LabelFontSize="8"
                                      LabelTextColor="#000000"
                                      LabelBackgroundColor="#ffffff"
                                      IsEditable="false"
                                      FeatureStyle="@(new()
                                      {
                                          FillColor = "#868E96",
                                          FillOpacity = 0.2,
                                          LineColor = "#868E96",
                                          Opacity = 1.0,
                                          LineWidth = 1,
                                      })" />

                       @*  <GeoJsonLayer Id="Extensions"
                                      DataUrl="api/townshipextensions"
                                      Pickable="true"
                                      Extruded="false"
                                      LineWidthScale="1"
                                      LineWidthMinPixels="1"
                                      TooltipConfig="@TooltipConfig.ForProperties("townshipExtensionOrFarmName")"
                                      UniqueIdProperty="geoTownshipExtensionOrFarmId"
                                      DisplayProperty="townshipExtensionOrFarmName"
                                      FeatureStyle="@(new()
                                      {
                                          FillColor = "#FF8C00",
                                          FillOpacity = 0.3,
                                          LineColor = "#FF8C00",
                                          LineWidth = 1,
                                      })"
                                      MinZoom="10"
                                      EnableViewportCulling />*@

                        <MVTLayer Id="Parcels"
                                  GeoServerUrl="https://lims.koleta.co.mz/geoserver"
                                  Workspace="PlannerSpatial"
                                  LayerName="vwParcelsLayer"
                                  Pickable="true"
                                  Visible="true"
                                  UniqueIdProperty="GeoPropertyID"
                                  LabelTextColor="#000000"
                                  LabelsEnabled="true"
                                  LabelProperty="CustomIdentifier"
                                  LabelMinZoom="12"
                                  FeatureStyle="@(new()
                                  {
                                      FillColor = "#0096FF",
                                      FillOpacity = 0.3,
                                      LineColor = "#0096FF",
                                      Opacity = 1.0,
                                      LineWidth = 1
                                  })"
                                  SelectionStyle="@FeatureStyle.Red"
                                  HoverStyle="@(new()
                                  {
                                      FillColor = "#FFD700",  // Gold
                                      FillOpacity = 0.8,
                                      LineColor = "#FF8C00",
                                      Opacity = 1.0
                                  })"
                                  TileLoadingDebounceMs="3000"
                                  TooltipConfig="@TooltipConfig.ForProperties("CustomIdentifier", "GeoPropertyID")"
                                  DisplayProperty="CustomIdentifier"
                                  EditableFields="@([
                                                        new AttributeFieldConfig
                                                        {
                                                            FieldName = "CustomIdentifier",
                                                            DisplayName = "Custom Identifier",
                                                            DataType = AttributeDataType.String,
                                                            IsReadOnly = true,
                                                            Order = 2
                                                        },
                                                        new AttributeFieldConfig
                                                        {
                                                            FieldName = "GeoPropertyID",
                                                            DisplayName = "GeoProperty ID",
                                                            DataType = AttributeDataType.Integer,
                                                            IsReadOnly = true,
                                                            Order = 1
                                                        }
                                                    ])"
                                  ExcludedProperties="@(["id", "InspectionProjectID", "InspectionStateCode", "layerName", "LocationLatitude", "LocationLongitude", "LPI", "Source", "Unit"])" /> 
                        
                        @* Location marker from query string (if provided) *@
                        @if (locationMarker != null)
                        {
                            <IconLayer Id="location-marker"
                                       Data="@locationMarker"
                                       IconSize="48"
                                       Pickable="true"
                                       Visible="true"
                                       HideFromLayerControl="true"
                                       TooltipConfig="@TooltipConfig.ForProperties("name")" />
                        }
                    </LayersContent>
                </DeckGLView>
            </MudExDockItem>
            <MudExDockItem Title="Selection" HideHeader MaximumWidth="300" Direction="DockDirection.Right">
                <MudCard Elevation="4" Style="height: 100%; display: flex; flex-direction: column;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText>Selection</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="flex: 1 1 auto; overflow: hidden; display: flex; flex-direction: column; padding: 0; min-height: 0;">
                        <div style="flex: 1 1 auto; overflow: hidden; min-height: 0;">
                            @* Always render FeatureSelectionControl so it can subscribe immediately *@
                            @* The control itself will show "No features selected" when appropriate *@
                            <FeatureSelectionControl DeckGLView="@deckGLView"
                                                     OnAttributesSaved="@OnAttributesSaved"
                                                     OnAttributesReset="@OnAttributesReset" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudExDockItem>
        </MudExDockLayout>
    </div>
</div>

@code {
/// <summary>
/// Optional location parameter from query string in Google Maps format: latitude,longitude
/// Example: ?loc=-25.98208,32.59083
/// </summary>
[SupplyParameterFromQuery(Name = "loc")]
public string? LocationQueryString { get; set; }

/// <summary>
/// Optional zoom level parameter from query string
/// Example: ?zoom=12
/// Valid range: 0-22 (typical web map zoom levels)
/// </summary>
[SupplyParameterFromQuery(Name = "zoom")]
public string? ZoomQueryString { get; set; }

private MapMode currentMapMode = MapMode.Explore;
private DeckGLView? deckGLView;
private object[]? locationMarker;

private ViewState initialViewState = new()
{
    Longitude = 32.59083,
    Latitude = -25.98208,
    Zoom = 16.31,
    Pitch = 0,
    Bearing = 0
};

private ViewState viewState = new()
{
    Longitude = 32.71,
    Latitude = -25.95,
    Zoom = 11
};

protected override void OnInitialized()
{
    // Parse zoom level if provided
    double? customZoom = null;
    if (!string.IsNullOrWhiteSpace(ZoomQueryString))
    {
        var (isValidZoom, zoomLevel) = ParseZoomLevel(ZoomQueryString);
        if (isValidZoom)
        {
            customZoom = zoomLevel;
            Console.WriteLine($"üîç Custom zoom level: {zoomLevel}");
        }
        else
        {
            Console.WriteLine($"‚ö†Ô∏è Invalid zoom format: {ZoomQueryString}. Expected a number between 0 and 22.");
        }
    }

    // Parse location query string if provided
    if (!string.IsNullOrWhiteSpace(LocationQueryString))
    {
        var (isValid, latitude, longitude) = ParseLocationString(LocationQueryString);
            
        if (isValid)
        {
            // Create marker data
            locationMarker = new[]
            {
                new
                {
                    coordinates = new[] { longitude, latitude },
                    name = $"Location: {latitude:F5}, {longitude:F5}"
                }
            };

            // Center map on the location with custom or default zoom
            initialViewState = new ViewState
            {
                Longitude = longitude,
                Latitude = latitude,
                Zoom = customZoom ?? 14, // Use custom zoom if provided, otherwise default to 14
                Pitch = 0,
                Bearing = 0
            };

            Console.WriteLine($"üìç Location marker created at: {latitude}, {longitude} (zoom: {initialViewState.Zoom})");
        }
        else
        {
            Console.WriteLine($"‚ö†Ô∏è Invalid location format: {LocationQueryString}. Expected format: latitude,longitude (e.g., -25.98208,32.59083)");
        }
    }
    else if (customZoom.HasValue)
    {
        // Zoom parameter provided without location - apply to default initial view
        initialViewState = new ViewState
        {
            Longitude = initialViewState.Longitude,
            Latitude = initialViewState.Latitude,
            Zoom = customZoom.Value,
            Pitch = initialViewState.Pitch,
            Bearing = initialViewState.Bearing
        };
        Console.WriteLine($"üîç Applied custom zoom level: {customZoom.Value} to default location");
    }
}

/// <summary>
/// Parses a Google Maps-style location string (latitude,longitude)
/// </summary>
/// <param name="locationString">Location string in format: "latitude,longitude" (e.g., "-25.98208,32.59083")</param>
/// <returns>Tuple with (isValid, latitude, longitude)</returns>
private static (bool IsValid, double Latitude, double Longitude) ParseLocationString(string locationString)
{
    ArgumentNullException.ThrowIfNull(locationString);

    // Split by comma
    var parts = locationString.Split(',', StringSplitOptions.TrimEntries);

    if (parts.Length != 2)
    {
        return (false, 0, 0);
    }

    // Try to parse latitude and longitude
    if (!double.TryParse(parts[0], CultureInfo.InvariantCulture, out double latitude) || 
        !double.TryParse(parts[1], CultureInfo.InvariantCulture, out double longitude))
    {
        return (false, 0, 0);
    }

    // Validate ranges
    if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180)
    {
        return (false, 0, 0);
    }

    return (true, latitude, longitude);
}

/// <summary>
/// Parses a zoom level string
/// </summary>
/// <param name="zoomString">Zoom level as string (e.g., "12" or "15.5")</param>
/// <returns>Tuple with (isValid, zoomLevel)</returns>
private static (bool IsValid, double ZoomLevel) ParseZoomLevel(string zoomString)
{
    ArgumentNullException.ThrowIfNull(zoomString);

    // Try to parse the zoom level
    if (!double.TryParse(zoomString, CultureInfo.InvariantCulture, out double zoom))
    {
        return (false, 0);
    }

    // Validate zoom range (typical web map range is 0-22, but allow up to 24 for flexibility)
    if (zoom < 0 || zoom > 24)
    {
        return (false, 0);
    }

    return (true, zoom);
}

private async Task OnDeckInitialized()
{
    Console.WriteLine("üéâ Deck.gl initialized!");

    StateHasChanged();
}

    private async Task OnMapModeChanged(MapMode newMode)
    {
        currentMapMode = newMode;

        if (deckGLView != null)
        {
            await deckGLView.SetMapMode(newMode);
        }

        StateHasChanged();
    }

    private void OnViewStateChanged(ViewState newViewState)
    {
        viewState = newViewState;
        StateHasChanged();
    }

    private Task OnAttributesSaved(object data)
    {
        // TODO: Implement actual save logic here
        // This would typically involve:
        // 1. Calling a backend API to persist the changes
        // 2. Updating the feature data in the layer
        // 3. Refreshing the layer to show the updated data

        // Example of what you might do:
        // await SaveFeatureToDatabase(data.LayerId, data.FeatureId, data.EditContext.CurrentValues);
        // await RefreshLayer(data.LayerId);

        return Task.CompletedTask;
    }

    private Task OnAttributesReset()
    {
        Console.WriteLine("‚Ü©Ô∏è Attributes reset to original values");
        return Task.CompletedTask;
    }
}

